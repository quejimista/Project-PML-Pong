import numpy as np
from stable_baselines3 import PPO
from pettingzoo.atari import pong_v3
import gymnasium as gym
import os

# Load trained agents
left_agent = PPO.load("left_side_trained_agent.zip")
right_agent = PPO.load("trained_pong_agent.zip")

# Create folder to save the video
video_folder = "pong_left_agent_video"
os.makedirs(video_folder, exist_ok=True)

# PettingZoo environment
env = pong_v3.env(render_mode="rgb_array")  # rgb_array mode needed for recording
env.reset(seed=42)

# Wrap with Gym's video recorder
env = gym.wrappers.RecordVideo(env, video_folder, episode_trigger=lambda x: True)

done = False
total_reward = 0

while not done:
    for agent in env.agent_iter():
        obs, reward, terminated, truncated, info = env.last()
        done = terminated or truncated
        if done:
            env.step(None)
            break
        else:
            if agent == "first_0":  # left agent
                action, _ = left_agent.predict(obs, deterministic=True)
            else:  # right agent
                action, _ = right_agent.predict(obs, deterministic=True)
            env.step(action)

        total_reward += reward


env.close()
print(f"Video saved in folder: {video_folder}")
print(f"Total reward for this episode: {total_reward}")
