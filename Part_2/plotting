import json
import matplotlib.pyplot as plt
import os

def plot_individual_metrics(json_path):
    """
    Loads a JSON file containing trial logs and plots metrics per episode.
    
    Args:
        json_path (str): Path to the JSON file.
    """
    # Load JSON
    with open(json_path, "r") as f:
        data = json.load(f)
    
    episodes = data.get("episodes", [])
    if not episodes:
        print("[WARN] No episodes found in JSON.")
        return

    # Extract episode numbers
    episode_nums = [ep["episode"] for ep in episodes]

    # Extract metrics, converting None/null to 0 for plotting
    reward = [ep["reward"] for ep in episodes]
    length = [ep["length"] for ep in episodes]
    policy_loss = [ep["policy_loss"] if ep["policy_loss"] is not None else 0 for ep in episodes]
    value_loss = [ep["value_loss"] if ep["value_loss"] is not None else 0 for ep in episodes]
    entropy_loss = [ep["entropy_loss"] if ep["entropy_loss"] is not None else 0 for ep in episodes]

    # Plot each metric
    plt.figure(figsize=(12, 8))

    plt.subplot(3, 2, 1)
    plt.plot(episode_nums, reward, marker='o')
    plt.title("Reward per Episode")
    plt.xlabel("Episode")
    plt.ylabel("Reward")

    plt.subplot(3, 2, 2)
    plt.plot(episode_nums, length, marker='o', color='orange')
    plt.title("Episode Length")
    plt.xlabel("Episode")
    plt.ylabel("Length")

    plt.subplot(3, 2, 3)
    plt.plot(episode_nums, policy_loss, marker='o', color='green')
    plt.title("Policy Loss")
    plt.xlabel("Episode")
    plt.ylabel("Loss")

    plt.subplot(3, 2, 4)
    plt.plot(episode_nums, value_loss, marker='o', color='red')
    plt.title("Value Loss")
    plt.xlabel("Episode")
    plt.ylabel("Loss")

    plt.subplot(3, 2, 5)
    plt.plot(episode_nums, entropy_loss, marker='o', color='purple')
    plt.title("Entropy Loss")
    plt.xlabel("Episode")
    plt.ylabel("Entropy")

    plt.tight_layout()
    plt.show()


def plot_metrics_all_trials(folder_path):
    """
    Plots reward, length, policy_loss, value_loss, and entropy_loss across all JSON trials.
    Each metric gets a single figure, with one line per JSON file.

    Args:
        folder_path (str): Folder containing JSON trial logs.
    """
    # List all JSON files in the folder
    json_files = [f for f in os.listdir(folder_path) if f.endswith(".json")]
    if not json_files:
        print("[WARN] No JSON files found in folder.")
        return

    metrics = ["reward", "length", "policy_loss", "value_loss", "entropy_loss"]

    # Prepare a dict to store metric data per JSON
    metric_data = {metric: [] for metric in metrics}
    trial_labels = []

    # Load each JSON file
    for f in json_files:
        path = os.path.join(folder_path, f)
        with open(path, "r") as file:
            data = json.load(file)

        episodes = data.get("episodes", [])
        if not episodes:
            continue

        trial_labels.append(f"trial {data.get('trial', '?')}")

        for metric in metrics:
            values = [ep[metric] if ep[metric] is not None else 0 for ep in episodes]
            metric_data[metric].append(values)

    # Plot each metric in a single figure
    for metric in metrics:
        plt.figure(figsize=(10, 6))
        for trial_values, label in zip(metric_data[metric], trial_labels):
            plt.plot(range(1, len(trial_values)+1), trial_values, label=label)
        plt.title(metric.replace("_", " ").title())
        plt.xlabel("Episode")
        plt.ylabel(metric.replace("_", " ").title())
        plt.legend()
        plt.show()


